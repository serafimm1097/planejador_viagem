<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Planejador de Viagem - Dashboard Financeiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3B82F6;
            --secondary: #10B981;
            --accent: #8B5CF6;
            --warning: #F59E0B;
            --danger: #EF4444;
            --light: #F3F4F6;
            --dark: #1F2937;
            --text-light: #F3F4F6;
            --text-dark: #1F2937;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-light);
            display: flex; /* Usar flexbox para centralizar o conteúdo de login */
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        @media (max-width: 768px) {
            .responsive-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Estilos para o Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: rgba(31, 41, 55, 0.95);
            margin: auto;
            padding: 30px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            width: 90%;
            max-width: 900px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.5);
            color: white;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .close-button {
            color: #ccc;
            float: right;
            font-size: 32px;
            font-weight: bold;
            position: absolute;
            top: 15px;
            right: 25px;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--primary);
            text-decoration: none;
        }

        /* Estilos para a barra de navegação inferior */
        #bottom-nav {
            height: 70px;
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-item {
            flex: 1;
            padding: 8px 0;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .nav-item.active {
            color: var(--primary);
            transform: translateY(-3px);
        }

        /* Estilos para o menu superior */
        #top-nav .nav-item {
            color: rgba(255, 255, 255, 0.7);
            padding: 10px 20px;
            border-radius: 10px;
            margin: 0 6px;
            font-weight: 500;
        }

        #top-nav .nav-item.active {
            background-color: rgba(59, 130, 246, 0.4);
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .nav-item:hover {
            color: white;
            background-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        /* Classes para controlar a visibilidade das seções */
        .content-section {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .content-section.active {
            display: block;
        }

        /* Ajuste para o corpo da página para evitar que o conteúdo fique por baixo da barra de navegação */
        @media (max-width: 1023px) {
            body {
                padding-bottom: 80px;
            }
        }

        /* Estilos para validação de formulário */
        .input-error {
            border-color: var(--danger) !important;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.5);
        }
        .error-message {
            color: var(--danger);
            font-size: 0.85rem;
            margin-top: 4px;
        }

        /* Estilos para o indicador de orçamento total */
        .budget-indicator {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1.2rem;
            color: white;
            position: relative;
            overflow: hidden;
            margin: 0 auto 20px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }

        .budget-indicator::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: conic-gradient(
                var(--primary) var(--progress-angle, 0deg),
                rgba(255,255,255,0.2) var(--progress-angle, 0deg)
            );
            border-radius: 50%;
            z-index: 1;
        }

        .budget-indicator span {
            position: relative;
            z-index: 2;
            background: var(--dark);
            padding: 5px 10px;
            border-radius: 10px;
        }

        /* Cores dinâmicas para as barras de progresso */
        .progress-bar-dynamic {
            transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out;
        }

        /* Esconder elementos do dashboard por padrão */
        .dashboard-elements {
            display: none;
        }

        /* Estilos para a seção de login */
        #login-section {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            width: 100%;
            padding: 1rem;
            box-sizing: border-box;
        }

        #login-card {
            width: 100%;
            max-width: 400px;
            text-align: center;
            padding: 2.5rem;
            border-radius: 1.5rem;
        }

        #login-card h1 {
            font-size: 2.25rem;
            font-weight: 700;
            color: white;
            margin-bottom: 1.5rem;
        }

        #login-card p {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 2rem;
        }

        #google-login-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 0.75rem 1.5rem;
            background-color: white;
            color: var(--dark);
            font-weight: 600;
            border-radius: 0.75rem;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #google-login-button:hover {
            background-color: #f0f0f0;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }

        #google-login-button img {
            width: 1.5rem;
            height: 1.5rem;
            margin-right: 0.75rem;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Seção de Login -->
    <div id="login-section">
        <div id="login-card" class="glass-effect card-hover">
            <h1>Bem-vindo ao Planejador de Viagem!</h1>
            <p>Faça login com sua conta Google para organizar e visualizar seus gastos.</p>
            <button id="google-login-button">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo">
                Entrar com Google
            </button>
        </div>
    </div>

    <!-- Currency Rates Display -->
    <div id="currency-rates" class="fixed top-0 left-0 right-0 bg-gray-800 bg-opacity-75 text-white text-sm p-2 z-50 flex justify-end space-x-4 dashboard-elements">
        <span>EUR: <span id="euro-rate">--</span></span>
        <span>USD: <span id="dollar-rate">--</span></span>
    </div>

    <!-- Top Navigation Bar for Desktop -->
    <nav id="top-nav" class="hidden lg:flex justify-center items-center bg-gray-800 bg-opacity-90 text-white p-2 rounded-lg mx-auto max-w-fit mb-8 mt-12 dashboard-elements">
        <button class="nav-item flex items-center text-sm px-4 py-2 rounded-lg transition duration-200" data-target="expenseFormSection">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Gastos</span>
        </button>
        <button class="nav-item flex items-center text-sm px-4 py-2 rounded-lg transition duration-200" data-target="budgetFormSection">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <span>Orçamento</span>
        </button>
        <button class="nav-item flex items-center text-sm px-4 py-2 rounded-lg transition duration-200" data-target="savedMoneySection">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08-.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Guardado</span>
        </button>
        <button class="nav-item flex items-center text-sm px-4 py-2 rounded-lg transition duration-200" data-target="dashboardSection">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9 0 0120.488 9z" />
            </svg>
            <span>Dashboard</span>
        </button>
        <!-- Botão de Logout -->
        <button id="logout-button" class="nav-item flex items-center text-sm px-4 py-2 rounded-lg transition duration-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
            <span>Sair</span>
        </button>
    </nav>

    <div class="max-w-7xl mx-auto pt-16 pb-16 lg:pt-8 lg:pb-8 dashboard-elements">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">🌍 Planejador de Viagem</h1>
            <p class="text-white/80 font-light">
                Organize e visualize seus gastos de viagem de forma estratégica
            </p>
        </div>

        <!-- Seção de Adicionar/Editar Gastos e Dashboard -->
        <div id="expenseFormSection" class="content-section active">
            <div class="grid lg:grid-cols-2 gap-8 responsive-grid">
                <!-- Formulário de Entrada -->
                <div class="glass-effect rounded-2xl p-6 card-hover">
                    <h2 class="text-2xl font-semibold text-white mb-6">Adicionar/Editar Gastos</h2>

                    <form id="expenseForm" class="space-y-4">
                        <input type="hidden" id="expenseId" />
                        <div>
                            <label class="block text-white/90 mb-2">Tipo de Gasto</label>
                            <select
                                id="expenseType"
                                class="w-full p-3 rounded-lg border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400"
                                style="background-color: #1f2937; color: white;"
                            >
                                <option value="transport">🚗 Passagem/Passagem</option>
                                <option value="accommodation">🏨 Hospedagem</option>
                                <option value="food">🍽️ Alimentação</option>
                                <option value="activities">🎭 Passeios/Atividades</option>
                                <option value="transfers">🚕 Transfers</option>
                                <option value="other">📦 Outros Gastos</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-white/90 mb-2">Descrição <span class="text-red-400">*</span></label>
                            <input
                                type="text"
                                id="expenseDescription"
                                placeholder="Ex: Passagem aérea São Paulo - Paris"
                                class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400"
                                required
                            />
                            <p id="error-expenseDescription" class="error-message hidden">A descrição é obrigatória.</p>
                        </div>

                        <div>
                            <label class="block text-white/90 mb-2">Fornecedor/Companhia (Opcional)</label>
                            <input
                                type="text"
                                id="expenseVendor"
                                placeholder="Ex: Latam, Hotel X, Restaurante Y"
                                class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400"
                            />
                        </div>

                        <div>
                            <label class="block text-white/90 mb-2">Valor (R$) <span class="text-red-400">*</span></label>
                            <input
                                type="number"
                                id="expenseAmount"
                                step="0.01"
                                min="0"
                                placeholder="0.00"
                                class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400"
                                required
                            />
                            <p id="error-expenseAmount" class="error-message hidden">O valor é obrigatório e deve ser maior que zero.</p>
                        </div>

                        <div>
                            <label class="block text-white/90 mb-2">Data <span class="text-red-400">*</span></label>
                            <input
                                type="date"
                                id="expenseDate"
                                class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400"
                                required
                            />
                            <p id="error-expenseDate" class="error-message hidden">A data é obrigatória.</p>
                        </div>

                        <button
                            type="submit"
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 transform hover:scale-105"
                        >
                            ➕ Adicionar/Atualizar Gasto
                        </button>
                    </form>

                    <!-- Resumo Rápido e Orçamento -->
                    <div class="mt-8 p-4 bg-white/5 rounded-lg">
                        <h3 class="text-white font-semibold mb-3">Resumo Financeiro e Orçamento</h3>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <span class="text-white/70">Total Gasto:</span>
                            <span class="text-white font-semibold text-right" id="totalAmount">R$ 0,00</span>

                            <span class="text-white/70">Orçamento Total:</span>
                            <span class="text-white font-semibold text-right" id="totalBudgetDisplay">R$ 0,00</span>

                            <span class="text-white/70">Restante/Excedente:</span>
                            <span class="font-semibold text-right" id="budgetDifference">R$ 0,00</span>
                        </div>
                        <hr class="my-3 border-white/10">
                        <div class="space-y-3">
                            <div>
                                <div class="flex justify-between text-white/70 text-sm mb-1">
                                    <span>Passagem: <span class="text-blue-300" id="transportAmount">R$ 0,00</span></span>
                                    <span>Orçamento: <span id="budgetTransportDisplay">R$ 0,00</span></span>
                                </div>
                                <div class="w-full bg-white/20 rounded-full h-2.5">
                                    <div id="transportProgressBar" class="h-2.5 rounded-full progress-bar-dynamic" style="width: 0%;"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-white/70 text-sm mb-1">
                                    <span>Hospedagem: <span class="text-green-300" id="accommodationAmount">R$ 0,00</span></span>
                                    <span>Orçamento: <span id="budgetAccommodationDisplay">R$ 0,00</span></span>
                                </div>
                                <div class="w-full bg-white/20 rounded-full h-2.5">
                                    <div id="accommodationProgressBar" class="h-2.5 rounded-full progress-bar-dynamic" style="width: 0%;"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-white/70 text-sm mb-1">
                                    <span>Alimentação: <span class="text-yellow-300" id="foodAmount">R$ 0,00</span></span>
                                    <span>Orçamento: <span id="budgetFoodDisplay">R$ 0,00</span></span>
                                </div>
                                <div class="w-full bg-white/20 rounded-full h-2.5">
                                    <div id="foodProgressBar" class="h-2.5 rounded-full progress-bar-dynamic" style="width: 0%;"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-white/70 text-sm mb-1">
                                    <span>Passeios: <span class="text-purple-300" id="activitiesAmount">R$ 0,00</span></span>
                                    <span>Orçamento: <span id="budgetActivitiesDisplay">R$ 0,00</span></span>
                                </div>
                                <div class="w-full bg-white/20 rounded-full h-2.5">
                                    <div id="activitiesProgressBar" class="h-2.5 rounded-full progress-bar-dynamic" style="width: 0%;"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-white/70 text-sm mb-1">
                                    <span>Transfers: <span class="text-pink-300" id="transfersAmount">R$ 0,00</span></span>
                                    <span>Orçamento: <span id="budgetTransfersDisplay">R$ 0,00</span></span>
                                </div>
                                <div class="w-full bg-white/20 rounded-full h-2.5">
                                    <div id="transfersProgressBar" class="h-2.5 rounded-full progress-bar-dynamic" style="width: 0%;"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-white/70 text-sm mb-1">
                                    <span>Outros: <span class="text-gray-300" id="otherAmount">R$ 0,00</span></span>
                                    <span>Orçamento: <span id="budgetOtherDisplay">R$ 0,00</span></span>
                                </div>
                                <div class="w-full bg-white/20 rounded-full h-2.5">
                                    <div id="otherProgressBar" class="h-2.5 rounded-full progress-bar-dynamic" style="width: 0%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dashboard -->
                <div id="dashboardSection" class="space-y-6">
                    <!-- Gráfico de Pizza -->
                    <div class="glass-effect rounded-2xl p-6 card-hover">
                        <h3 class="text-white font-semibold mb-4">Distribuição de Gastos</h3>
                        <div class="h-64">
                            <canvas id="expenseChart"></canvas>
                        </div>
                    </div>

                    <!-- Gráfico de Orçamento vs. Gasto -->
                    <div class="glass-effect rounded-2xl p-6 card-hover">
                        <h3 class="text-white font-semibold mb-4">Orçamento vs. Gastos Reais</h3>
                        <div class="h-64">
                            <canvas id="budgetVsExpenseChart"></canvas>
                        </div>
                    </div>

                    <!-- Estatísticas -->
                    <div class="grid grid-cols-2 gap-4">
                        <div
                            class="glass-effect rounded-xl p-4 text-center card-hover"
                        >
                            <div class="text-2xl font-bold text-blue-300 mb-1" id="totalExpenses">0</div>
                            <div class="text-white/70 text-sm">Gastos Registrados</div>
                        </div>
                        <div
                            class="glass-effect rounded-xl p-4 text-center card-hover"
                        >
                            <div class="text-2xl font-bold text-green-300 mb-1" id="averageExpense">R$ 0</div>
                            <div class="text-white/70 text-sm">Média por Gasto</div>
                        </div>
                    </div>

                    <!-- Lista de Gastos -->
                    <div class="glass-effect rounded-2xl p-6 card-hover">
                        <h3 class="text-white font-semibold mb-4">Últimos Gastos</h3>
                        <div
                            id="expenseList"
                            class="space-y-2 max-h-48 overflow-y-auto"
                        >
                            <div class="text-white/60 text-center py-4">
                                Nenhum gasto registrado ainda
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulário de Orçamento -->
        <div id="budgetFormSection" class="mt-8 glass-effect rounded-2xl p-6 card-hover content-section">
            <h2 class="text-2xl font-semibold text-white mb-6">Definir Orçamento da Viagem</h2>
            <div class="budget-indicator" id="totalBudgetIndicator">
                <span>0%</span>
            </div>
            <form id="budgetForm" class="space-y-4">
                <div>
                    <label class="block text-white/90 mb-2">Orçamento Total (R$) <span class="text-red-400">*</span></label>
                    <input type="number" id="totalBudget" step="0.01" min="0" placeholder="Ex: 5000.00"
                           class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400" required />
                    <p id="error-totalBudget" class="error-message hidden">O orçamento total é obrigatório e deve ser maior que zero.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-white/90 mb-2">Orçamento Passagem (R$)</label>
                        <input type="number" id="budgetTransport" step="0.01" min="0" placeholder="0.00"
                               class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400" />
                    </div>
                    <div>
                        <label class="block text-white/90 mb-2">Orçamento Hospedagem (R$)</label>
                        <input type="number" id="budgetAccommodation" step="0.01" min="0" placeholder="0.00"
                               class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400" />
                    </div>
                    <div>
                        <label class="block text-white/90 mb-2">Orçamento Alimentação (R$)</label>
                        <input type="number" id="budgetFood" step="0.01" min="0" placeholder="0.00"
                               class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400" />
                    </div>
                    <div>
                        <label class="block text-white/90 mb-2">Orçamento Passeios (R$)</label>
                        <input type="number" id="budgetActivities" step="0.01" min="0" placeholder="0.00"
                               class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400" />
                    </div>
                    <div>
                        <label class="block text-white/90 mb-2">Orçamento Transfers (R$)</label>
                        <input type="number" id="budgetTransfers" step="0.01" min="0" placeholder="0.00"
                               class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400" />
                    </div>
                    <div>
                        <label class="block text-white/90 mb-2">Orçamento Outros (R$)</label>
                        <input type="number" id="budgetOther" step="0.01" min="0" placeholder="0.00"
                               class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400" />
                    </div>
                </div>
                <button
                    type="submit"
                    class="w-full bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 transform hover:scale-105"
                >
                    💰 Salvar Orçamento
                </button>
            </form>
        </div>

        <!-- Seção de Dinheiro Guardado -->
        <div id="savedMoneySection" class="mt-8 glass-effect rounded-2xl p-6 card-hover content-section">
            <h2 class="text-2xl font-semibold text-white mb-6">💰 Meu Dinheiro Guardado</h2>

            <form id="savedMoneyForm" class="space-y-4">
                <div>
                    <label class="block text-white/90 mb-2">Valor Guardado (R$) <span class="text-red-400">*</span></label>
                    <input
                        type="number"
                        id="savedMoneyAmount"
                        step="0.01"
                        min="0"
                        placeholder="0.00"
                        class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400"
                        required
                    />
                    <p id="error-savedMoneyAmount" class="error-message hidden">O valor guardado é obrigatório e deve ser maior ou igual a zero.</p>
                </div>
                <button
                    type="submit"
                    class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 transform hover:scale-105"
                >
                    Salvar Dinheiro Guardado
                </button>
            </form>

            <div class="mt-6 p-4 bg-white/5 rounded-lg">
                <h3 class="text-white font-semibold mb-3">Resumo do Dinheiro Guardado</h3>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <span class="text-white/70">Total Guardado:</span>
                    <span class="text-white font-semibold text-right" id="displaySavedMoney">R$ 0,00</span>

                    <span class="text-white/70">Equivalente em EUR:</span>
                    <span class="text-white font-semibold text-right" id="displaySavedMoneyEUR">€ 0,00</span>

                    <span class="text-white/70">Equivalente em USD:</span>
                    <span class="text-white font-semibold text-right" id="displaySavedMoneyUSD">$ 0,00</span>
                </div>
            </div>
        </div>

        <!-- Seção de Comparativos por Categoria -->
        <div class="mt-8 glass-effect rounded-2xl p-6">
            <h2 class="text-2xl font-semibold text-white mb-4">Comparativos por Categoria</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <button onclick="openComparisonModal('transport')" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 text-sm transform hover:scale-105">
                    🚗 Passagem
                </button>
                <button onclick="openComparisonModal('accommodation')" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 text-sm transform hover:scale-105">
                    🏨 Hospedagem
                </button>
                <button onclick="openComparisonModal('food')" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 text-sm transform hover:scale-105">
                    🍽️ Alimentação
                </button>
                <button onclick="openComparisonModal('activities')" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 text-sm transform hover:scale-105">
                    🎭 Passeios
                </button>
                <button onclick="openComparisonModal('transfers')" class="bg-pink-500 hover:bg-pink-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 text-sm transform hover:scale-105">
                    🚕 Transfers
                </button>
                <button onclick="openComparisonModal('other')" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 text-sm transform hover:scale-105">
                    📦 Outros
                </button>
            </div>
        </div>

        <!-- Filtros e Ações -->
        <div class="mt-8 glass-effect rounded-2xl p-6">
            <div class="flex flex-wrap gap-4 items-center">
                <h3 class="text-white font-semibold">Filtros</h3>
                <select
                    id="filterType"
                    class="p-2 rounded-lg border border-white/20 text-white"
                    style="background-color: #1f2937; color: white;"
                >
                    <option value="all">Todos os Tipos</option>
                    <option value="transport">Passagem</option>
                    <option value="accommodation">Hospedagem</option>
                    <option value="food">Alimentação</option>
                    <option value="activities">Passeios</option>
                    <option value="transfers">Transfers</option>
                    <option value="other">Outros</option>
                </select>
                <button
                    onclick="exportData()"
                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition duration-200 transform hover:scale-105"
                >
                    📊 Exportar Dados
                </button>
                <button
                    onclick="clearAll()"
                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-200 transform hover:scale-105"
                >
                    🗑️ Limpar Tudo
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Comparativo -->
    <div id="comparisonModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeComparisonModal()">&times;</span>
            <h2 id="modalTitle" class="text-2xl font-bold mb-4">Comparativo de Gastos</h2>
            <div class="h-64 mb-6">
                <canvas id="comparisonChart"></canvas>
            </div>
            <h3 class="text-xl font-semibold mb-3">Detalhes dos Gastos:</h3>
            <div id="modalExpenseList" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                <!-- Detalhes dos gastos serão carregados aqui -->
            </div>
        </div>
    </div>

    <!-- Bottom Navigation Bar for Mobile/Tablet -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-gray-800 bg-opacity-90 text-white p-2 flex justify-around items-center z-50 lg:hidden dashboard-elements">
        <button class="nav-item flex flex-col items-center text-xs text-blue-300" data-target="expenseFormSection">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Gastos</span>
        </button>
        <button class="nav-item flex flex-col items-center text-xs" data-target="budgetFormSection">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <span>Orçamento</span>
        </button>
        <button class="nav-item flex flex-col items-center text-xs" data-target="savedMoneySection">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08-.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Guardado</span>
        </button>
        <button class="nav-item flex flex-col items-center text-xs" data-target="dashboardSection">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9 0 0120.488 9z" />
            </svg>
            <span>Dashboard</span>
        </button>
        <!-- Botão de Logout para Mobile -->
        <button id="logout-button-mobile" class="nav-item flex flex-col items-center text-xs">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
            <span>Sair</span>
        </button>
    </nav>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        // import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics.js"; // Analytics é opcional

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC3hXUF-jJ91SldMnBZtA3pQp0svMWfVpc",
            authDomain: "viagem-3f571.firebaseapp.com",
            projectId: "viagem-3f571",
            storageBucket: "viagem-3f571.firebasestorage.app",
            messagingSenderId: "408294999625",
            appId: "1:408294999625:web:6f772b7fdd5c37b83d6198",
            measurementId: "G-28L336CQ3H"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        // const analytics = getAnalytics(app); // Descomente se for usar Analytics

        // Referências aos elementos da UI
        const loginSection = document.getElementById('login-section');
        const dashboardElements = document.querySelectorAll('.dashboard-elements');
        const googleLoginButton = document.getElementById('google-login-button');
        const logoutButton = document.getElementById('logout-button');
        const logoutButtonMobile = document.getElementById('logout-button-mobile');

        // Variáveis globais para dados (serão substituídas por dados do Firestore)
        let expenses = [];
        let budgets = {};
        let savedMoney = 0;

        // Mapeamento de tipos para labels e cores
        const typeLabels = {
            transport: { label: 'Passagem/Passagem', color: '#3B82F6', icon: '🚗' },
            accommodation: { label: 'Hospedagem', color: '#10B981', icon: '🏨' },
            food: { label: 'Alimentação', color: '#F59E0B', icon: '🍽️' },
            activities: { label: 'Passeios/Atividades', color: '#8B5CF6', icon: '🎭' },
            transfers: { label: 'Transfers', color: '#EC4899', icon: '🚕' },
            other: { label: 'Outros Gastos', color: '#6B7280', icon: '📦' },
        };

        // Gráficos (declarados globalmente para poderem ser destruídos e recriados)
        let expenseChart;
        let budgetVsExpenseChart;
        let comparisonChart;

        // Função para mostrar/esconder elementos do dashboard
        function toggleDashboardVisibility(isVisible) {
            if (isVisible) {
                loginSection.style.display = 'none';
                // Garante que os elementos do dashboard tenham o display correto (flex, block, etc.)
                dashboardElements.forEach(el => {
                    const tagName = el.tagName.toLowerCase();
                    if (tagName === 'nav') {
                        el.style.display = el.id === 'top-nav' ? 'flex' : 'flex'; // top-nav é hidden lg:flex, bottom-nav é flex
                    } else if (tagName === 'div' && el.id === 'currency-rates') {
                        el.style.display = 'flex';
                    } else {
                        el.style.display = 'block';
                    }
                });

                document.body.classList.remove('justify-center', 'items-center'); // Remover centralização do body
                document.body.style.paddingBottom = '80px'; // Adicionar padding para mobile nav
                document.body.style.minHeight = '100vh'; // Garantir min-height

                // Re-inicializar o dashboard após o login
                // TODO: No futuro, carregar dados do Firestore aqui
                loadBudgets(); // Carrega os orçamentos (se houver dados locais ou do Firestore)
                updateDashboard(); // Atualiza todos os gráficos, resumos e listas
                updateSavedMoneyDisplay(); // Atualiza a exibição do dinheiro guardado
                fetchCurrencyRates(); // Busca e exibe as taxas de câmbio

                // Define a data atual para o campo de data de despesa
                document.getElementById('expenseDate').valueAsDate = new Date();
                // Define o valor inicial para o campo de dinheiro guardado
                document.getElementById('savedMoneyAmount').value = savedMoney.toFixed(2);

                // Ativa a primeira seção do dashboard por padrão e a navegação
                showSection('expenseFormSection');

            } else {
                loginSection.style.display = 'flex';
                dashboardElements.forEach(el => el.style.display = 'none');
                document.body.classList.add('justify-center', 'items-center'); // Centralizar o body para a tela de login
                document.body.style.paddingBottom = '0'; // Remover padding
                document.body.style.minHeight = '100vh'; // Garantir min-height
            }
        }

        // Lógica de Login com Google
        googleLoginButton.addEventListener('click', async () => {
            try {
                await signInWithPopup(auth, provider);
                // onAuthStateChanged vai lidar com a visibilidade
            } catch (error) {
                console.error("Erro ao fazer login com Google:", error);
                alert("Erro ao fazer login. Por favor, tente novamente.");
            }
        });

        // Lógica de Logout
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // onAuthStateChanged vai lidar com a visibilidade
            } catch (error) {
                console.error("Erro ao fazer logout:", error);
                alert("Erro ao fazer logout. Por favor, tente novamente.");
            }
        });

        logoutButtonMobile.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // onAuthStateChanged vai lidar com a visibilidade
            } catch (error) {
                console.error("Erro ao fazer logout:", error);
                alert("Erro ao fazer logout. Por favor, tente novamente.");
            }
        });

        // Observar o estado de autenticação
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuário logado
                console.log("Usuário logado:", user.displayName);
                toggleDashboardVisibility(true);
                // TODO: Aqui é onde você integraria o carregamento de dados do Firestore
                // Ex: loadUserData(user.uid);
            } else {
                // Usuário deslogado
                console.log("Usuário deslogado.");
                toggleDashboardVisibility(false);
                // Limpar dados locais ao deslogar
                expenses = [];
                budgets = {};
                savedMoney = 0;
            }
        });

        // Função para buscar cotações de moedas
        async function fetchCurrencyRates() {
            try {
                let today = new Date();
                let euroRate = null;
                let dollarRate = null;
                let attempts = 0;
                const maxAttempts = 7;

                while ((!euroRate || !dollarRate) && attempts < maxAttempts) {
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    const formattedDate = `${mm}-${dd}-${yyyy}`;

                    const euroResponse = await fetch(`https://olinda.bcb.gov.br/olinda/servico/PTAX/versao/v1/odata/CotacaoMoedaDia(moeda=@moeda,dataCotacao=@dataCotacao)?@moeda='EUR'&@dataCotacao='${formattedDate}'&$top=1&$orderby=dataHoraCotacao%20desc&$format=json`);
                    const euroData = await euroResponse.json();
                    if (euroData.value && euroData.value.length > 0) {
                        euroRate = euroData.value[0].cotacaoVenda;
                    }

                    const dollarResponse = await fetch(`https://olinda.bcb.gov.br/olinda/servico/PTAX/versao/v1/odata/CotacaoMoedaDia(moeda=@moeda,dataCotacao=@dataCotacao)?@moeda='USD'&@dataCotacao='${formattedDate}'&$top=1&$orderby=dataHoraCotacao%20desc&$format=json`);
                    const dollarData = await dollarResponse.json();
                    if (dollarData.value && dollarData.value.length > 0) {
                        dollarRate = dollarData.value[0].cotacaoVenda;
                    }

                    if (!euroRate || !dollarRate) {
                        today.setDate(today.getDate() - 1);
                        attempts++;
                    }
                }

                if (euroRate) {
                    document.getElementById('euro-rate').textContent = `R$ ${euroRate.toFixed(2)}`;
                    document.getElementById('displaySavedMoneyEUR').textContent = `€ ${(savedMoney / euroRate).toFixed(2)}`;
                } else {
                    document.getElementById('euro-rate').textContent = 'N/A';
                    document.getElementById('displaySavedMoneyEUR').textContent = `€ N/A`;
                }

                if (dollarRate) {
                    document.getElementById('dollar-rate').textContent = `R$ ${dollarRate.toFixed(2)}`;
                    document.getElementById('displaySavedMoneyUSD').textContent = `$ ${(savedMoney / dollarRate).toFixed(2)}`;
                } else {
                    document.getElementById('dollar-rate').textContent = 'N/A';
                    document.getElementById('displaySavedMoneyUSD').textContent = `$ N/A`;
                }

            } catch (error) {
                console.error('Erro ao buscar cotações de moedas:', error);
                document.getElementById('euro-rate').textContent = 'Erro';
                document.getElementById('dollar-rate').textContent = 'Erro';
                document.getElementById('displaySavedMoneyEUR').textContent = `€ Erro`;
                document.getElementById('displaySavedMoneyUSD').textContent = `$ Erro`;
            }
        }

        // Salvar dinheiro guardado (agora no Firebase, mas aqui apenas atualiza a variável local)
        function saveSavedMoney() {
            const amountInput = document.getElementById('savedMoneyAmount');
            const amount = parseFloat(amountInput.value);
            const errorMessage = document.getElementById('error-savedMoneyAmount');

            if (isNaN(amount) || amount < 0) {
                amountInput.classList.add('input-error');
                errorMessage.textContent = 'Por favor, insira um valor válido (maior ou igual a zero).';
                errorMessage.classList.remove('hidden');
                return;
            } else {
                amountInput.classList.remove('input-error');
                errorMessage.classList.add('hidden');
            }

            savedMoney = amount;
            // TODO: Salvar `savedMoney` no Firebase Firestore
            updateSavedMoneyDisplay();
            fetchCurrencyRates();
            alert('Dinheiro guardado atualizado com sucesso!');
        }

        // Atualizar exibição do dinheiro guardado
        function updateSavedMoneyDisplay() {
            document.getElementById('displaySavedMoney').textContent = `R$ ${savedMoney.toFixed(2)}`;
        }

        // Inicializar a aplicação
        document.addEventListener('DOMContentLoaded', function () {
            // A visibilidade inicial é controlada por onAuthStateChanged, que será disparado automaticamente.
            // Não precisamos chamar as funções de inicialização aqui, pois toggleDashboardVisibility fará isso.

            // Configurar o formulário de gastos
            document
                .getElementById('expenseForm')
                .addEventListener('submit', function (e) {
                    e.preventDefault();
                    addOrUpdateExpense();
                });

            // Configurar o formulário de orçamento
            document
                .getElementById('budgetForm')
                .addEventListener('submit', function (e) {
                    e.preventDefault();
                    saveBudgets();
                });

            // Configurar o formulário de dinheiro guardado
            document
                .getElementById('savedMoneyForm')
                .addEventListener('submit', function (e) {
                    e.preventDefault();
                    saveSavedMoney();
                });

            // Configurar filtros
            document
                .getElementById('filterType')
                .addEventListener('change', updateDashboard);

            // Fechar modal ao clicar fora
            window.onclick = function(event) {
                const modal = document.getElementById('comparisonModal');
                if (event.target == modal) {
                    closeComparisonModal();
                }
            }

            // Lógica da barra de navegação inferior (e agora superior)
            const navButtons = document.querySelectorAll('.nav-item');
            const contentSections = document.querySelectorAll('.content-section');

            window.showSection = function(targetId) { // Tornar global para ser acessível
                contentSections.forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(targetId).classList.add('active');

                navButtons.forEach(button => {
                    button.classList.remove('active');
                    button.classList.remove('text-blue-300'); // Para nav-item do bottom-nav
                    if (button.closest('#top-nav')) {
                        button.style.backgroundColor = '';
                        button.style.color = 'rgba(255, 255, 255, 0.7)';
                    }
                });
                document.querySelectorAll(`.nav-item[data-target="${targetId}"]`).forEach(activeButton => {
                    if (activeButton) {
                        activeButton.classList.add('active');
                        if (activeButton.closest('#bottom-nav')) {
                            activeButton.classList.add('text-blue-300');
                        } else if (activeButton.closest('#top-nav')) {
                            activeButton.style.backgroundColor = 'rgba(59, 130, 246, 0.4)';
                            activeButton.style.color = 'white';
                        }
                    }
                });
            }

            navButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetId = this.dataset.target;
                    showSection(targetId);
                    // Se a seção não for o dashboard e não for a top-nav (para evitar scroll desnecessário em desktop)
                    if (targetId !== 'dashboardSection' && !this.closest('#top-nav')) {
                        // Rola para o topo da seção, útil em mobile
                        document.getElementById(targetId).scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            });
        });

        // Validação de formulário genérica
        function validateInput(inputElement, errorMessageElement, validationFn) {
            const isValid = validationFn(inputElement.value);
            if (!isValid) {
                inputElement.classList.add('input-error');
                errorMessageElement.classList.remove('hidden');
            } else {
                inputElement.classList.remove('input-error');
                errorMessageElement.classList.add('hidden');
            }
            return isValid;
        }

        // Adicionar ou Atualizar gasto (agora no Firebase)
        function addOrUpdateExpense() {
            const id = document.getElementById('expenseId').value;
            const type = document.getElementById('expenseType').value;
            const descriptionInput = document.getElementById('expenseDescription');
            const vendor = document.getElementById('expenseVendor').value.trim();
            const amountInput = document.getElementById('expenseAmount');
            const dateInput = document.getElementById('expenseDate');

            let isValid = true;

            isValid = validateInput(descriptionInput, document.getElementById('error-expenseDescription'), value => value.trim() !== '') && isValid;
            isValid = validateInput(amountInput, document.getElementById('error-expenseAmount'), value => !isNaN(parseFloat(value)) && parseFloat(value) > 0) && isValid;
            isValid = validateInput(dateInput, document.getElementById('error-expenseDate'), value => value.trim() !== '') && isValid;

            if (!isValid) {
                alert('Por favor, preencha todos os campos obrigatórios corretamente.');
                return;
            }

            const description = descriptionInput.value.trim();
            const amount = parseFloat(amountInput.value);
            const date = dateInput.value;

            const expenseData = {
                type,
                description,
                vendor,
                amount,
                date,
                timestamp: new Date().toISOString(),
            };

            if (id) {
                // TODO: Atualizar gasto no Firebase Firestore
                const expenseIndex = expenses.findIndex(exp => exp.id == id);
                if (expenseIndex > -1) {
                    expenses[expenseIndex] = { ...expenses[expenseIndex], ...expenseData };
                }
            } else {
                // TODO: Adicionar novo gasto no Firebase Firestore
                expenses.push({ id: Date.now(), ...expenseData }); // Temporário para visualização
            }

            // saveData(); // Não mais necessário com Firebase
            updateDashboard();
            resetExpenseForm();
        }

        // Preencher formulário para edição
        window.editExpense = function(id) { // Tornar global para ser acessível do HTML
            const expense = expenses.find(exp => exp.id === id);
            if (expense) {
                document.getElementById('expenseId').value = expense.id;
                document.getElementById('expenseType').value = expense.type;
                document.getElementById('expenseDescription').value = expense.description;
                document.getElementById('expenseVendor').value = expense.vendor || '';
                document.getElementById('expenseAmount').value = expense.amount;
                document.getElementById('expenseDate').value = expense.date;
                document.querySelector('#expenseForm button[type="submit"]').textContent = '✏️ Atualizar Gasto';
                // Limpar mensagens de erro ao editar
                document.querySelectorAll('.error-message').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
            }
        }

        // Remover gasto (agora no Firebase)
        window.deleteExpense = function(id) { // Tornar global para ser acessível do HTML
            if (confirm('Tem certeza que deseja remover este gasto?')) {
                expenses = expenses.filter(exp => exp.id !== id);
                // TODO: Remover gasto do Firebase Firestore
                // saveData(); // Não mais necessário com Firebase
                updateDashboard();
            }
        }

        // Resetar formulário de gastos
        function resetExpenseForm() {
            document.getElementById('expenseId').value = '';
            document.getElementById('expenseType').value = 'transport';
            document.getElementById('expenseDescription').value = '';
            document.getElementById('expenseVendor').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseDate').valueAsDate = new Date();
            document.querySelector('#expenseForm button[type="submit"]').textContent = '➕ Adicionar Gasto';
            // Limpar mensagens de erro
            document.querySelectorAll('.error-message').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
        }

        // Carregar dados de orçamento (agora do Firebase)
        function loadBudgets() {
            // TODO: Carregar `budgets` do Firebase Firestore
            document.getElementById('totalBudget').value = budgets.total || '';
            document.getElementById('budgetTransport').value = budgets.transport || '';
            document.getElementById('budgetAccommodation').value = budgets.accommodation || '';
            document.getElementById('budgetFood').value = budgets.food || '';
            document.getElementById('budgetActivities').value = budgets.activities || '';
            document.getElementById('budgetTransfers').value = budgets.transfers || '';
            document.getElementById('budgetOther').value = budgets.other || '';
        }

        // Salvar dados de orçamento (agora no Firebase)
        function saveBudgets() {
            const totalBudgetInput = document.getElementById('totalBudget');
            const totalBudget = parseFloat(totalBudgetInput.value);
            const errorMessage = document.getElementById('error-totalBudget');

            if (isNaN(totalBudget) || totalBudget <= 0) {
                totalBudgetInput.classList.add('input-error');
                errorMessage.textContent = 'O orçamento total é obrigatório e deve ser maior que zero.';
                errorMessage.classList.remove('hidden');
                return;
            } else {
                totalBudgetInput.classList.remove('input-error');
                errorMessage.classList.add('hidden');
            }

            budgets.total = totalBudget;
            budgets.transport = parseFloat(document.getElementById('budgetTransport').value) || 0;
            budgets.accommodation = parseFloat(document.getElementById('budgetAccommodation').value) || 0;
            budgets.food = parseFloat(document.getElementById('budgetFood').value) || 0;
            budgets.activities = parseFloat(document.getElementById('budgetActivities').value) || 0;
            budgets.transfers = parseFloat(document.getElementById('budgetTransfers').value) || 0;
            budgets.other = parseFloat(document.getElementById('budgetOther').value) || 0;

            // TODO: Salvar `budgets` no Firebase Firestore
            updateDashboard();
            alert('Orçamento salvo com sucesso!');
        }

        // Função para obter a cor da barra de progresso baseada na porcentagem
        function getProgressBarColor(percentage) {
            if (percentage >= 100) {
                return 'var(--danger)';
            } else if (percentage >= 75) {
                return 'var(--warning)';
            } else {
                return 'var(--primary)';
            }
        }

        // Função auxiliar para obter o menor valor de uma categoria
        // NOTA: A função original `getMinAmountForCategory` parece estar incorreta para o propósito de "total gasto".
        // Ela deveria somar todos os gastos de uma categoria, não pegar o mínimo.
        // Ajustei para `getTotalAmountForCategory` para somar os valores.
        function getTotalAmountForCategory(categoryType) {
            const categoryExpenses = expenses.filter((e) => e.type === categoryType);
            return categoryExpenses.reduce((sum, e) => sum + e.amount, 0);
        }

        // Atualizar dashboard
        function updateDashboard() {
            const filterType = document.getElementById('filterType').value;
            let filteredExpenses = expenses;

            if (filterType !== 'all') {
                filteredExpenses = expenses.filter((exp) => exp.type === filterType);
            }

            const totals = {
                transport: getTotalAmountForCategory('transport'),
                accommodation: getTotalAmountForCategory('accommodation'),
                food: getTotalAmountForCategory('food'),
                activities: getTotalAmountForCategory('activities'),
                transfers: getTotalAmountForCategory('transfers'),
                other: getTotalAmountForCategory('other'),
            };

            const totalAmount = Object.values(totals).reduce((sum, val) => sum + val, 0);

            // Atualizar resumo de gastos
            document.getElementById('totalAmount').textContent = `R$ ${totalAmount.toFixed(2)}`;
            document.getElementById('transportAmount').textContent = `R$ ${totals.transport.toFixed(2)}`;
            document.getElementById('accommodationAmount').textContent = `R$ ${totals.accommodation.toFixed(2)}`;
            document.getElementById('foodAmount').textContent = `R$ ${totals.food.toFixed(2)}`;
            document.getElementById('activitiesAmount').textContent = `R$ ${totals.activities.toFixed(2)}`;
            document.getElementById('transfersAmount').textContent = `R$ ${totals.transfers.toFixed(2)}`;
            document.getElementById('otherAmount').textContent = `R$ ${totals.other.toFixed(2)}`;

            // Atualizar resumo de orçamento
            document.getElementById('totalBudgetDisplay').textContent = `R$ ${budgets.total ? budgets.total.toFixed(2) : '0.00'}`;
            document.getElementById('budgetTransportDisplay').textContent = `R$ ${budgets.transport ? budgets.transport.toFixed(2) : '0.00'}`;
            document.getElementById('budgetAccommodationDisplay').textContent = `R$ ${budgets.accommodation ? budgets.accommodation.toFixed(2) : '0.00'}`;
            document.getElementById('budgetFoodDisplay').textContent = `R$ ${budgets.food ? budgets.food.toFixed(2) : '0.00'}`;
            document.getElementById('budgetActivitiesDisplay').textContent = `R$ ${budgets.activities ? budgets.activities.toFixed(2) : '0.00'}`;
            document.getElementById('budgetTransfersDisplay').textContent = `R$ ${budgets.transfers ? budgets.transfers.toFixed(2) : '0.00'}`;
            document.getElementById('budgetOtherDisplay').textContent = `R$ ${budgets.other ? budgets.other.toFixed(2) : '0.00'}`;

            // Calcular e exibir diferença do orçamento total
            const remaining = (budgets.total || 0) - totalAmount;
            const budgetDiffElement = document.getElementById('budgetDifference');
            budgetDiffElement.textContent = `R$ ${remaining.toFixed(2)}`;
            budgetDiffElement.classList.remove('text-green-300', 'text-red-400');
            if (remaining < 0) {
                budgetDiffElement.classList.add('text-red-400');
            } else {
                budgetDiffElement.classList.add('text-green-300');
            }

            // Atualizar barras de progresso com cores dinâmicas
            updateProgressBar('transportProgressBar', totals.transport, budgets.transport, typeLabels.transport.color);
            updateProgressBar('accommodationProgressBar', totals.accommodation, budgets.accommodation, typeLabels.accommodation.color);
            updateProgressBar('foodProgressBar', totals.food, budgets.food, typeLabels.food.color);
            updateProgressBar('activitiesProgressBar', totals.activities, budgets.activities, typeLabels.activities.color);
            updateProgressBar('transfersProgressBar', totals.transfers, budgets.transfers, typeLabels.transfers.color);
            updateProgressBar('otherProgressBar', totals.other, budgets.other, typeLabels.other.color);

            // Atualizar indicador de orçamento total
            updateTotalBudgetIndicator(totalAmount, budgets.total);

            // Atualizar estatísticas
            document.getElementById('totalExpenses').textContent = expenses.length;
            document.getElementById('averageExpense').textContent = `R$ ${
                expenses.length ? (totalAmount / expenses.length).toFixed(2) : '0.00'
            }`;

            // Atualizar gráficos
            updateExpenseChart(totals);
            updateBudgetVsExpenseChart(totals, budgets);

            // Atualizar lista
            updateExpenseList(filteredExpenses);
        }

        // Função para atualizar barra de progresso com cores dinâmicas
        function updateProgressBar(id, spent, budget, baseColor) {
            const progressBar = document.getElementById(id);
            if (!progressBar) return;

            let percentage = 0;
            if (budget > 0) {
                percentage = (spent / budget) * 100;
            } else if (spent > 0) { // Se não há orçamento mas há gasto, mostra 100% (excedido)
                percentage = 100;
            }

            const displayPercentage = Math.min(percentage, 100);
            progressBar.style.width = `${displayPercentage}%`;

            let color = baseColor;
            if (percentage >= 100) {
                color = 'var(--danger)';
            } else if (percentage >= 75) {
                color = 'var(--warning)';
            }
            progressBar.style.backgroundColor = color;
        }

        // Atualizar indicador de orçamento total
        function updateTotalBudgetIndicator(spent, totalBudget) {
            const indicator = document.getElementById('totalBudgetIndicator');
            const indicatorText = indicator.querySelector('span');

            let percentage = 0;
            if (totalBudget > 0) {
                percentage = (spent / totalBudget) * 100;
            } else if (spent > 0) {
                percentage = 100;
            }

            const displayPercentage = Math.min(percentage, 100);
            indicatorText.textContent = `${displayPercentage.toFixed(0)}%`;

            let color = 'var(--primary)';
            if (percentage >= 100) {
                color = 'var(--danger)';
            } else if (percentage >= 75) {
                color = 'var(--warning)';
            }

            indicator.style.setProperty('--progress-angle', `${percentage * 3.6}deg`);
            // A cor do background do conic-gradient deve ser dinâmica também
            indicator.style.background = `conic-gradient(${color} ${percentage * 3.6}deg, rgba(255,255,255,0.2) ${percentage * 3.6}deg)`;
        }

        // Atualizar gráfico de pizza (Distribuição de Gastos)
        function updateExpenseChart(totals) {
            const ctx = document.getElementById('expenseChart').getContext('2d');

            if (expenseChart) {
                expenseChart.destroy();
            }

            const labels = [
                typeLabels.transport.label,
                typeLabels.accommodation.label,
                typeLabels.food.label,
                typeLabels.activities.label,
                typeLabels.transfers.label,
                typeLabels.other.label,
            ];
            const dataValues = [
                totals.transport,
                totals.accommodation,
                totals.food,
                totals.activities,
                totals.transfers,
                totals.other,
            ];
            const backgroundColors = [
                typeLabels.transport.color,
                typeLabels.accommodation.color,
                typeLabels.food.color,
                typeLabels.activities.color,
                typeLabels.transfers.color,
                typeLabels.other.color,
            ];

            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            data: dataValues,
                            backgroundColor: backgroundColors,
                            borderWidth: 2,
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'white',
                                font: {
                                    size: 12,
                                },
                            },
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                        const percentage = total > 0 ? (context.parsed / total * 100).toFixed(1) : 0;
                                        label += `R$ ${context.parsed.toFixed(2)} (${percentage}%)`;
                                    }
                                    return label;
                                },
                            },
                        },
                    },
                },
            });
        }

        // Novo gráfico: Orçamento vs. Gastos Reais
        function updateBudgetVsExpenseChart(totals, budgets) {
            const ctx = document.getElementById('budgetVsExpenseChart').getContext('2d');

            if (budgetVsExpenseChart) {
                budgetVsExpenseChart.destroy();
            }

            const labels = [
                typeLabels.transport.label,
                typeLabels.accommodation.label,
                typeLabels.food.label,
                typeLabels.activities.label,
                typeLabels.transfers.label,
                typeLabels.other.label,
            ];

            const actualExpensesData = [
                totals.transport,
                totals.accommodation,
                totals.food,
                totals.activities,
                totals.transfers,
                totals.other,
            ];

            const budgetData = [
                budgets.transport || 0,
                budgets.accommodation || 0,
                budgets.food || 0,
                budgets.activities || 0,
                budgets.transfers || 0,
                budgets.other || 0,
            ];

            budgetVsExpenseChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Gastos Reais',
                            data: actualExpensesData,
                            backgroundColor: [
                                typeLabels.transport.color,
                                typeLabels.accommodation.color,
                                typeLabels.food.color,
                                typeLabels.activities.color,
                                typeLabels.transfers.color,
                                typeLabels.other.color,
                            ],
                            borderColor: 'rgba(255, 255, 255, 0.5)',
                            borderWidth: 1,
                        },
                        {
                            label: 'Orçamento',
                            data: budgetData,
                            backgroundColor: 'rgba(255, 255, 255, 0.2)',
                            borderColor: 'rgba(255, 255, 255, 0.5)',
                            borderWidth: 1,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: false,
                            ticks: {
                                color: 'white',
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)',
                            },
                        },
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            ticks: {
                                color: 'white',
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(2);
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)',
                            },
                        },
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: 'white',
                            },
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += `R$ ${context.parsed.y.toFixed(2)}`;
                                    }
                                    return label;
                                },
                            },
                        },
                    },
                },
            });
        }

        // Atualizar lista de gastos
        function updateExpenseList(expensesList) {
            const listContainer = document.getElementById('expenseList');

            if (expensesList.length === 0) {
                listContainer.innerHTML =
                    '<div class="text-white/60 text-center py-4">Nenhum gasto encontrado</div>';
                return;
            }

            const sortedExpenses = [...expensesList].sort((a, b) => new Date(b.date) - new Date(a.date));

            listContainer.innerHTML = sortedExpenses
                .map(
                    (expense) => `
                <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg hover:bg-white/10 transition duration-200">
                    <div class="flex-1">
                        <div class="text-white font-medium">${expense.description}</div>
                        ${expense.vendor ? `<div class="text-sm text-white/70">Fornecedor: ${expense.vendor}</div>` : ''}
                        <div class="text-white/60 text-sm">${new Date(
                            expense.date
                        ).toLocaleDateString('pt-BR')}</div>
                    </div>
                    <div class="text-right flex flex-col items-end">
                        <div class="text-white font-semibold">R$ ${expense.amount.toFixed(
                            2
                        )}</div>
                        <div class="text-white/60 text-sm capitalize">${getTypeLabel(
                            expense.type
                        )}</div>
                        <div class="flex gap-2 mt-2">
                            <button onclick="editExpense(${expense.id})" class="text-blue-400 hover:text-blue-300 text-sm transition duration-200">Editar</button>
                            <button onclick="deleteExpense(${expense.id})" class="text-red-400 hover:text-red-300 text-sm transition duration-200">Excluir</button>
                        </div>
                    </div>
                </div>
            `
                )
                .join('');
        }

        // Obter label do tipo
        function getTypeLabel(type) {
            return typeLabels[type] ? typeLabels[type].label : type;
        }

        // Exportar dados (agora do Firebase)
        window.exportData = function() { // Tornar global para ser acessível do HTML
            if (expenses.length === 0) {
                alert('Não há dados para exportar.');
                return;
            }

            const csvHeader = 'data,tipo,descricao,fornecedor,valor\n';
            const csvRows = expenses
                .map(
                    (exp) =>
                        `${exp.date},${getTypeLabel(exp.type)},"${exp.description.replace(/"/g, '""')}","${(exp.vendor || '').replace(/"/g, '""')}",${exp.amount}`
                )
                .join('\n');

            const csv = csvHeader + csvRows;
            const blob = new Blob(
                [csv],
                { type: 'text/csv;charset=utf-8;' }
            );
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gastos-viagem.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Limpar todos os dados (agora do Firebase)
        window.clearAll = function() { // Tornar global para ser acessível do HTML
            if (
                confirm(
                    'Tem certeza que deseja limpar TODOS os dados (gastos, orçamentos e dinheiro guardado)? Esta ação não pode ser desfeita.'
                )
            ) {
                expenses = [];
                budgets = {};
                savedMoney = 0;
                // TODO: Remover todos os dados do Firebase Firestore
                updateDashboard();
                loadBudgets(); // Recarrega os campos de orçamento para 0
                updateSavedMoneyDisplay(); // Recarrega o display de dinheiro guardado para 0
                resetExpenseForm(); // Limpa o formulário de gastos
            }
        }

        // Funções do Modal de Comparativo
        window.openComparisonModal = function(categoryType) { // Tornar global para ser acessível do HTML
            const modal = document.getElementById('comparisonModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalExpenseList = document.getElementById('modalExpenseList');

            const categoryInfo = typeLabels[categoryType];
            modalTitle.textContent = `Comparativo de Gastos: ${categoryInfo.icon} ${categoryInfo.label}`;

            const filteredExpenses = expenses.filter(exp => exp.type === categoryType);

            // Agrupar gastos por fornecedor
            const groupedByVendor = filteredExpenses.reduce((acc, expense) => {
                const vendorName = expense.vendor || 'Não Informado';
                if (!acc[vendorName]) {
                    acc[vendorName] = 0;
                }
                acc[vendorName] += expense.amount;
                return acc;
            }, {});

            const labels = Object.keys(groupedByVendor);
            const dataValues = Object.values(groupedByVendor);

            // Gerar cores dinamicamente para o gráfico de barras
            const backgroundColors = labels.map((_, index) => {
                const baseColor = categoryInfo.color;
                const color = Chart.helpers.color(baseColor).lighten(index * 0.05).rgbString();
                return color;
            });

            // Atualizar gráfico de comparação
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            if (comparisonChart) {
                comparisonChart.destroy();
            }
            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Total Gasto em ${categoryInfo.label}`,
                        data: dataValues,
                        backgroundColor: backgroundColors,
                        borderColor: 'rgba(255, 255, 255, 0.5)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'white',
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(2);
                                }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += `R$ ${context.parsed.y.toFixed(2)}`;
                                    }
                                    return label;
                                },
                            },
                        },
                    }
                }
            });

            // Atualizar lista de detalhes dos gastos no modal
            if (filteredExpenses.length === 0) {
                modalExpenseList.innerHTML = '<div class="text-white/60 text-center py-4">Nenhum gasto registrado nesta categoria.</div>';
            } else {
                const sortedModalExpenses = [...filteredExpenses].sort((a, b) => new Date(b.date) - new Date(a.date));
                modalExpenseList.innerHTML = sortedModalExpenses.map(expense => `
                    <div class="flex justify-between items-center p-2 bg-white/10 rounded-lg">
                        <div>
                            <div class="font-medium">${expense.description}</div>
                            ${expense.vendor ? `<div class="text-sm text-white/70">Fornecedor: ${expense.vendor}</div>` : ''}
                            <div class="text-xs text-white/60">${new Date(expense.date).toLocaleDateString('pt-BR')}</div>
                        </div>
                        <div class="font-semibold">R$ ${expense.amount.toFixed(2)}</div>
                    </div>
                `).join('');
            }

            modal.style.display = 'flex';
        }

        window.closeComparisonModal = function() { // Tornar global para ser acessível do HTML
            document.getElementById('comparisonModal').style.display = 'none';
        }
    </script>
</body>
</html>
